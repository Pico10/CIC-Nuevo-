<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario - CIC Pavón Arriba</title>
  <link rel="stylesheet" href="../Styles/formulario.css">
  <link rel="icon" href="../Icons/icono-pavon-arriba.jpeg" type="image/png">

  <style>
    /* Caja tipo captcha (visible aunque el CSS externo lo pise) */
    #captchaBox {
      display: flex !important;
      align-items: center !important;
      justify-content: space-between !important;
      gap: 14px !important;
      padding: 14px 16px !important;
      margin-top: 10px !important;
      border: 2px solid rgba(0, 0, 0, .18) !important;
      border-radius: 12px !important;
      background: #f7f7f7 !important;
      box-shadow: 0 3px 10px rgba(0, 0, 0, .08) !important;
      width: 100% !important;
    }

    #captchaLeft {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      flex: 1 1 auto !important;
      min-width: 220px !important;
    }

    #declJurada {
      width: 26px !important;
      height: 26px !important;
      transform: scale(1.15) !important;
      accent-color: #1f6feb !important;
      cursor: pointer !important;
    }

    #captchaText {
      font-weight: 800 !important;
      font-size: 16px !important;
      line-height: 1.2 !important;
      cursor: pointer !important;
      user-select: none !important;
    }

    #captchaMini {
      font-size: 12px !important;
      opacity: .85 !important;
      margin-top: 2px !important;
    }

    #captchaBadge {
      display: flex !important;
      flex-direction: column !important;
      align-items: flex-end !important;
      gap: 2px !important;
      flex: 0 0 auto !important;
      padding-left: 10px !important;
      border-left: 1px solid rgba(0, 0, 0, .12) !important;
    }

    #captchaBadge .t1 {
      font-size: 12px !important;
      font-weight: 800 !important;
      opacity: .85 !important;
    }

    #captchaBadge .t2 {
      font-size: 11px !important;
      opacity: .7 !important;
    }
  </style>
</head>

<body>
  <div class="volver-container">
    <a href="../index.html" class="btn-volver">Volver al inicio</a>
  </div>

  <div class="container">
    <a href="../index.html">
      <img src="../Images/PavonArriba.jpg" alt="Icono Formulario" class="icono-form">
    </a>

    <h2>Complete el formulario</h2>

    <form id="formulario">
      <!-- HOUSEHOLD -->
      <fieldset>
        <legend>Grupo familiar (Household)</legend>
        <div class="row">
          <div class="col-6">
            <label for="familiaExistente">¿Agregar a una familia existente?</label>
            <select id="familiaExistente">
              <option value="">— Crear nueva familia —</option>
            </select>
            <div class="hint">Seleccione una familia existente o cree una nueva</div>
          </div>
        </div>

        <div class="row" id="nuevaFamiliaSection">
          <div class="col-3">
            <label for="hhId">ID de Household (automático)</label>
            <input id="hhId" placeholder="Se genera automáticamente" readonly style="background: #f5f5f5;" />
            <div class="hint">Este campo se completa solo</div>
          </div>

          <div class="col-3">
            <label for="grupoFamiliar">Nombre de grupo familiar</label>
            <input id="grupoFamiliar" placeholder="p. ej. Gómez-Pérez" />
          </div>

          <div class="col-2">
            <label for="vivienda">Vivienda</label>
            <select id="vivienda">
              <option value="">—</option>
              <option>Propia</option>
              <option>Alquilada</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-2"><label for="calle">Calle</label><input id="calle" /></div>
          <div class="col-1"><label for="numero">Número</label><input id="numero" /></div>
          <div class="col-2"><label for="barrio">Barrio</label><input id="barrio" /></div>

          <div class="col-2">
            <label for="ciudad">Localidad</label>
            <select id="ciudad">
              <option value="">—</option>
              <option>Pavón Arriba</option>
              <option>Rosario</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-2">
            <label for="provincia">Provincia</label>
            <select id="provincia">
              <option value="">—</option>
              <option>Santa Fe</option>
              <option>Otro</option>
            </select>
          </div>
        </div>
      </fieldset>

      <!-- PERSONA -->
      <fieldset>
        <legend>Persona</legend>
        <div class="row">
          <div class="col-2">
            <label for="relacionHogar">Relación</label>
            <select id="relacionHogar">
              <option value="">—</option>
              <option>Padre</option>
              <option>Madre</option>
              <option>Hijo</option>
              <option>Hija</option>
              <option>Abuelo</option>
              <option>Abuela</option>
              <option>Tío</option>
              <option>Tía</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-2"><label for="nombre">Nombre</label><input id="nombre" required /></div>
          <div class="col-2"><label for="apellido">Apellido</label><input id="apellido" required /></div>

          <div class="col-2">
            <label for="dni">DNI</label>
            <input id="dni" type="text" placeholder="12345678" maxlength="8" required inputmode="numeric" />
          </div>

          <div class="col-3">
            <label for="cuit">CUIT/CUIL</label>
            <input id="cuit" type="text" placeholder="20-12345678-9" maxlength="13" required />
            <div class="hint">Formato: XX-XXXXXXXX-X</div>
          </div>

          <div class="col-2">
            <label for="fechaNacimiento">Fecha Nac.</label>
            <input id="fechaNacimiento" type="date" required />
          </div>

          <div class="col-2">
            <label for="sexo">Sexo</label>
            <select id="sexo" required>
              <option value="">—</option>
              <option>Masculino</option>
              <option>Femenino</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-3"><label for="email">Correo</label><input id="email" type="email" /></div>

          <!-- TELÉFONO OBLIGATORIO -->
          <div class="col-3">
            <label for="telefono">Teléfono</label>
            <input
              id="telefono"
              required
              inputmode="numeric"
              autocomplete="tel"
              placeholder="Ej: 3411234567"
              maxlength="12"
            />
            <div class="hint">Obligatorio. Solo números. Sin 0 y sin 15. Ej: 3411234567</div>
          </div>

          <div class="col-3">
            <label for="ocupacion">Ocupación</label>
            <select id="ocupacion" required>
              <option value="">—</option>
              <option>Empleado/a</option>
              <option>Monotributista</option>
              <option>Jubilado/a</option>
              <option>Desempleado/a</option>
              <option>Estudiante</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-3">
            <label for="estadoCivil">Estado civil</label>
            <select id="estadoCivil" required>
              <option value="">—</option>
              <option>Soltero/a</option>
              <option>Casado/a</option>
              <option>Concubinato</option>
              <option>Divorciado/a</option>
              <option>Viudo/a</option>
            </select>
          </div>
        </div>
      </fieldset>

      <!-- EDUCACIÓN -->
      <fieldset>
        <legend>Educación</legend>
        <div class="row">
          <div class="col-2">
            <label for="nivelActual">Nivel actual</label>
            <select id="nivelActual">
              <option value="">—</option>
              <option>Ninguno</option>
              <option>Primario</option>
              <option>Secundario</option>
              <option>Terciario</option>
              <option>Universitario</option>
              <option>Posgrado</option>
            </select>
          </div>
          <div class="col-2"><label for="institucion">Institución</label><input id="institucion" /></div>
          <div class="col-2">
            <label for="estadoEdu">Estado</label>
            <select id="estadoEdu">
              <option value="">—</option>
              <option>Cursando</option>
              <option>Completo</option>
              <option>Incompleto</option>
            </select>
          </div>
          <div class="col-6">
            <label for="anteriores">Estudios anteriores (uno por línea: nivel | institución | estado)</label>
            <textarea id="anteriores" rows="3"
              placeholder="secundario | Esc. Nº 321 | completo&#10;curso | Taller X | completo"></textarea>
          </div>
        </div>
      </fieldset>

      <!-- DISCAPACIDAD / BENEFICIO / OBRA SOCIAL -->
      <fieldset>
        <legend>Discapacidad / Beneficio / Obra social</legend>
        <div class="row">
          <div class="col-2">
            <label for="tieneDis">¿Tiene discapacidad?</label>
            <select id="tieneDis">
              <option value="">—</option>
              <option value="false">No</option>
              <option value="true">Sí</option>
            </select>
          </div>

          <div id="discapacidadExtra" style="display: none; width: 100%;">
            <div class="row">
              <div class="col-2">
                <label for="tipoDis">Tipo</label>
                <input id="tipoDis" placeholder="Auditiva, Visual, Motriz..." />
              </div>
              <div class="col-2">
                <label for="tratDis">Tratamiento médico</label>
                <select id="tratDis">
                  <option value="">—</option>
                  <option value="false">No</option>
                  <option value="true">Sí</option>
                </select>
              </div>
              <div class="col-2">
                <label for="conCUD">¿Con CUD?</label>
                <select id="conCUD">
                  <option value="">—</option>
                  <option value="false">No</option>
                  <option value="true">Sí</option>
                </select>
              </div>
              <div class="col-2">
                <label for="cudVto">Vencimiento CUD</label>
                <input id="cudVto" type="date" />
              </div>
            </div>
          </div>

          <div class="col-2">
            <label for="tieneBen">¿Plan / Beneficio?</label>
            <select id="tieneBen">
              <option value="">—</option>
              <option value="false">No</option>
              <option value="true">Sí</option>
            </select>
          </div>
          <div class="col-2"><label for="nomBen">Nombre plan</label><input id="nomBen" placeholder="AUH, Progresar..." /></div>
          <div class="col-2"><label for="orgBen">Organismo</label><input id="orgBen" placeholder="ANSES, MDS..." /></div>
          <div class="col-2">
            <label for="estBen">Estado</label>
            <select id="estBen">
              <option value="">—</option>
              <option>Activo</option>
              <option>Suspendido</option>
              <option>Finalizado</option>
            </select>
          </div>

          <div class="col-2">
            <label for="tieneOS">¿Obra social?</label>
            <select id="tieneOS">
              <option value="">—</option>
              <option value="false">No</option>
              <option value="true">Sí</option>
            </select>
          </div>
          <div class="col-2"><label for="nomOS">Nombre OS</label><input id="nomOS" placeholder="IAPOS, PAMI..." /></div>
        </div>
      </fieldset>

      <!-- CAPTCHA VISUAL -->
      <div class="row">
        <div class="col-6" style="width:100% !important;">
          <div id="captchaBox">
            <label id="captchaLeft" for="declJurada">
              <input id="declJurada" type="checkbox" />
              <div>
                <div id="captchaText">El presente reviste carácter de declaración jurada</div>
                <div id="captchaMini">Debe marcar esta casilla para poder guardar.</div>
              </div>
            </label>
            <div id="captchaBadge" aria-hidden="true">
              <div class="t1">CIC</div>
              <div class="t2">Verificación</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-3"><button class="ghost" type="reset">Reiniciar Formulario</button></div>
        <div class="col-3"><button class="primary" type="submit">Guardar</button></div>
      </div>
      <p id="status" class="hint"></p>
    </form>
  </div>

  <!-- Script: discapacidad + validaciones -->
  <script>
    (function () {
      const form = document.getElementById("formulario");
      const status = document.getElementById("status");

      const familiaExistente = document.getElementById("familiaExistente");
      const nuevaFamiliaSection = document.getElementById("nuevaFamiliaSection");

      const grupoFamiliar = document.getElementById("grupoFamiliar");
      const vivienda = document.getElementById("vivienda");
      const calle = document.getElementById("calle");
      const numero = document.getElementById("numero");
      const barrio = document.getElementById("barrio");

      const tieneDis = document.getElementById("tieneDis");
      const extraDis = document.getElementById("discapacidadExtra");

      const tel = document.getElementById("telefono");
      const dni = document.getElementById("dni");
      const cuit = document.getElementById("cuit");
      const decl = document.getElementById("declJurada");

      function setStatus(msg) { if (status) status.textContent = msg || ""; }

      // Mostrar/ocultar discapacidad
      if (tieneDis && extraDis) {
        tieneDis.addEventListener("change", () => {
          extraDis.style.display = (tieneDis.value === "true") ? "block" : "none";
        });
      }

      // Household: requeridos SOLO si crea nueva familia
      function syncHouseholdRequired() {
        const creandoNueva = !familiaExistente || !familiaExistente.value;

        if (nuevaFamiliaSection) nuevaFamiliaSection.style.display = creandoNueva ? "" : "none";

        const req = (el, on) => { if (el) el.required = !!on; };
        req(grupoFamiliar, creandoNueva);
        req(vivienda, creandoNueva);
        req(calle, creandoNueva);
        req(numero, creandoNueva);
        req(barrio, creandoNueva);

        // opcional: si querés que ciudad/provincia también sean obligatorios al crear nueva familia, descomentá:
        // req(document.getElementById("ciudad"), creandoNueva);
        // req(document.getElementById("provincia"), creandoNueva);
      }

      if (familiaExistente) {
        familiaExistente.addEventListener("change", () => {
          setStatus("");
          syncHouseholdRequired();
        });
      }
      document.addEventListener("DOMContentLoaded", syncHouseholdRequired);

      // Teléfono: solo números, sin 0 ni 15
      function normalizarTelefono(v) { return (v || "").replace(/\D/g, ""); }
      function validarTelefono() {
        if (!tel) return true;
        const limpio = normalizarTelefono(tel.value);
        if (tel.value !== limpio) tel.value = limpio;

        if (!limpio) { tel.setCustomValidity("Por favor, complete el teléfono (obligatorio)."); return false; }
        if (limpio.startsWith("0")) { tel.setCustomValidity("Ingresá el teléfono sin 0 al inicio (ej: 3411234567)."); return false; }
        if (limpio.startsWith("15")) { tel.setCustomValidity("Ingresá el teléfono sin 15 (ej: 3411234567)."); return false; }
        if (limpio.length < 6 || limpio.length > 12) { tel.setCustomValidity("Teléfono inválido. Solo números, sin 0 y sin 15."); return false; }

        tel.setCustomValidity("");
        return true;
      }

      // DNI: solo números 8
      function normalizarDni(v) { return (v || "").replace(/\D/g, ""); }
      function validarDni() {
        if (!dni) return true;
        const limpio = normalizarDni(dni.value);
        if (dni.value !== limpio) dni.value = limpio;

        if (!limpio) { dni.setCustomValidity("Por favor, complete el DNI (obligatorio)."); return false; }
        if (limpio.length !== 8) { dni.setCustomValidity("DNI inválido (debe tener 8 dígitos)."); return false; }

        dni.setCustomValidity("");
        return true;
      }

      // CUIT: valida formato simple y que contenga el DNI en el medio
      function normalizarCuit(v) { return (v || "").replace(/[^\d-]/g, "").trim(); }
      function soloDigitos(v) { return (v || "").replace(/\D/g, ""); }

      function validarCuitVsDni() {
        if (!cuit || !dni) return true;

        const dniVal = normalizarDni(dni.value);
        const cuitDig = soloDigitos(cuit.value); // 11 dígitos idealmente

        if (!cuit.value) { cuit.setCustomValidity("Por favor, complete el CUIT/CUIL (obligatorio)."); return false; }

        if (cuitDig.length !== 11) {
          cuit.setCustomValidity("CUIT/CUIL inválido (debe tener 11 dígitos). Ej: 20-12345678-9");
          return false;
        }

        const dniEnCuit = cuitDig.slice(2, 10); // 8 del medio
        if (dniVal && dniVal.length === 8 && dniEnCuit !== dniVal) {
          cuit.setCustomValidity("El CUIT/CUIL no coincide con el DNI (los 8 del medio deben ser el DNI).");
          dni.setCustomValidity("El DNI debe coincidir con el del medio del CUIT/CUIL.");
          return false;
        }

        cuit.setCustomValidity("");
        if (dni.validationMessage.includes("coincidir")) dni.setCustomValidity("");
        return true;
      }

      // Declaración jurada obligatoria
      function validarDecl() {
        if (!decl) return true;
        if (!decl.checked) { decl.setCustomValidity("Debe aceptar la declaración jurada para continuar."); return false; }
        decl.setCustomValidity("");
        return true;
      }

      // Inputs live
      tel?.addEventListener("input", () => { setStatus(""); validarTelefono(); });
      dni?.addEventListener("input", () => { setStatus(""); validarDni(); validarCuitVsDni(); });
      cuit?.addEventListener("input", () => { setStatus(""); cuit.value = normalizarCuit(cuit.value); validarCuitVsDni(); });
      decl?.addEventListener("change", () => { setStatus(""); validarDecl(); });

      // Submit: NO rompe app.js. Solo bloquea si hay errores.
      form?.addEventListener("submit", async (e) => {
        setStatus("");

        // forzar required household según selección
        syncHouseholdRequired();

        const okTel = validarTelefono();
        const okDni = validarDni();
        const okCuit = validarCuitVsDni();
        const okDecl = validarDecl();

        // checkValidity cubre los demás required (nombre, apellido, etc.)
        const okNative = form.checkValidity();

        if (!okTel || !okDni || !okCuit || !okDecl || !okNative) {
          e.preventDefault();
          e.stopImmediatePropagation();
          form.reportValidity();
          setStatus("Revisá los campos obligatorios antes de guardar.");
          return;
        }

        // Anti-duplicado (si app.js lo provee). Si no existe, no molesta.
        try {
          if (typeof window.__CHECK_DNI_EXISTS === "function") {
            const dniVal = normalizarDni(dni.value);
            const exists = await window.__CHECK_DNI_EXISTS(dniVal);
            if (exists) {
              e.preventDefault();
              e.stopImmediatePropagation();
              dni.setCustomValidity("Ya existe una persona con este DNI.");
              dni.reportValidity();
              setStatus("Ese DNI ya está registrado. No se puede duplicar.");
              return;
            }
          }
        } catch (err) {
          // Si falla el check, NO bloqueamos guardado para no romper “como antes”
          console.warn("CHECK DNI EXISTS error:", err);
        }

        // Si llegamos acá, dejamos que app.js guarde como siempre
      }, true);
    })();
  </script>

  <!-- App principal -->
  <script type="module" src="../JavaScript/app.js"></script>

  <footer>
    &copy; 2024 CIC Pavón Arriba - Todos los derechos reservados.
  </footer>
</body>

</html>
