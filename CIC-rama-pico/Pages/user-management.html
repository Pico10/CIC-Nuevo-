<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestión de Usuarios - CIC</title>

  <link rel="stylesheet" href="../Styles/admin.css" />
  <link rel="icon" href="../Icons/icono-pavon-arriba.jpeg" type="image/png" />
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <h1>Gestión de Usuarios - CIC</h1>
    <nav class="nav-links">
      <a href="admin.html">Panel Principal</a>
      <a href="../index.html">Inicio</a>
      <a href="#" onclick="logout()">Cerrar Sesión</a>
    </nav>
  </div>

  <!-- CONTENIDO -->
  <div class="container">
    <!-- FORM ALTA USUARIO (✅ SOLO ADMIN) -->
    <h2 data-permission="users:create">Agregar Nuevo Usuario</h2>
    <form
      id="userForm"
      data-permission="users:create"
      style="
        background: #ffffff;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      "
    >
      <div
        style="
          display: grid;
          grid-template-columns: repeat(2, minmax(0, 1fr));
          gap: 15px;
          margin-bottom: 15px;
        "
      >
        <div>
          <label>Usuario:</label>
          <input
            type="text"
            id="newUsername"
            required
            style="width: 100%; padding: 8px"
          />
        </div>

        <div>
          <label>Contraseña:</label>
          <input
            type="password"
            id="newPassword"
            required
            style="width: 100%; padding: 8px"
          />
        </div>

        <div>
          <label>Rol:</label>
          <select
            id="newRole"
            required
            style="width: 100%; padding: 8px"
          >
            <option value="">Seleccionar</option>
            <option value="admin">Administrador</option>
            <option value="profesional">Profesional</option>
            <option value="operador">Operador</option>
            <option value="lectura">Solo Lectura</option>
          </select>
        </div>

        <div>
          <label>Email:</label>
          <input
            type="email"
            id="newEmail"
            style="width: 100%; padding: 8px"
          />
        </div>
      </div>

      <button type="submit" class="btn btn-primary" data-permission="users:create">
        Crear Usuario
      </button>
    </form>

    <!-- LISTA USUARIOS -->
    <h2>Usuarios del Sistema</h2>
    <div id="usersList"></div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { db } from "../JavaScript/firebase.js";
    import {
      collection,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    import {
      initPagePermissions,
      assertCanCreateUsers,
      assertCanEditUsers,
      assertCanDeleteRecords,
      logAudit,
      isMasterAdmin,
    } from "../JavaScript/permissions.js";

    // ==============================
    // HELPERS
    // ==============================
    const USERS_COL = "users";

    function normUsername(u) {
      return (u || "").trim();
    }

    function roleLabel(role) {
      if (role === "admin") return "Administrador";
      if (role === "profesional") return "Profesional";
      if (role === "operador") return "Operador";
      if (role === "lectura") return "Solo Lectura";
      return role || "—";
    }

    function currentUserName() {
      return (
        sessionStorage.getItem("cicUser") ||
        sessionStorage.getItem("currentUser") ||
        "desconocido"
      );
    }

    // ==============================
    // FIRESTORE: CRUD
    // ==============================
    async function getUsers() {
      const snap = await getDocs(collection(db, USERS_COL));
      const list = [];
      snap.forEach((d) => list.push({ id: d.id, ...d.data() }));
      // Orden: admin primero, luego por usuario
      list.sort((a, b) => {
        const ar = (a.role || "").toLowerCase();
        const br = (b.role || "").toLowerCase();
        const prio = (r) =>
          r === "admin" ? 0 : r === "profesional" ? 1 : r === "operador" ? 2 : 3;
        const pa = prio(ar), pb = prio(br);
        if (pa !== pb) return pa - pb;
        return (a.username || a.id || "").localeCompare(b.username || b.id || "");
      });
      return list;
    }

    async function userExists(username) {
      const ref = doc(db, USERS_COL, username);
      const snap = await getDoc(ref);
      return snap.exists();
    }

    async function createUserFirestore(newUser) {
      // ID del doc = username (usuario)
      const username = newUser.username;
      const ref = doc(db, USERS_COL, username);

      const exists = await getDoc(ref);
      if (exists.exists()) {
        throw new Error("Ya existe un usuario con ese nombre.");
      }

      await setDoc(ref, newUser);
    }

    async function updateUserFirestore(username, data) {
      const ref = doc(db, USERS_COL, username);
      await updateDoc(ref, data);
    }

    async function deleteUserFirestore(username) {
      const ref = doc(db, USERS_COL, username);
      await deleteDoc(ref);
    }

    // ==============================
    // RENDER
    // ==============================
    async function loadUsers() {
      const container = document.getElementById("usersList");
      const esMaestro = isMasterAdmin();

      try {
        const users = await getUsers();

        if (!users.length) {
          container.innerHTML =
            '<p style="margin-top:10px;">No hay usuarios creados todavía.</p>';
          return;
        }

        let html = `
          <div class="data-table">
            <div class="table-header">
              <h3>Usuarios del Sistema</h3>
              <span>${users.length} usuarios</span>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Usuario</th>
                    <th>Rol</th>
                    <th>Email</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
        `;

        users.forEach((user) => {
          const estado =
            user.status === "pending"
              ? "Pendiente"
              : user.active
              ? "Activo"
              : "Inactivo";

          const badgeColor =
            user.status === "pending"
              ? "background:#fff3cd;color:#856404;"
              : user.active
              ? "background:#d1e7dd;color:#0f5132;"
              : "background:#f8d7da;color:#842029;";

          const btnAprobar =
            esMaestro && user.status === "pending"
              ? `<button class="btn btn-primary btn-small" data-role-min="admin" onclick="approveUser('${user.id}')">Aprobar</button>`
              : "";

          html += `
            <tr>
              <td>${user.username || user.id}</td>
              <td>${roleLabel(user.role)}</td>
              <td>${user.email || "N/A"}</td>
              <td>
                <span style="padding:4px 8px;border-radius:12px;font-size:12px;${badgeColor}">
                  ${estado}
                </span>
              </td>
              <td class="actions-cell">
                ${btnAprobar}

                <button
                  class="btn btn-small"
                  data-permission="users:edit"
                  onclick="editUser('${user.id}')"
                >
                  Editar
                </button>

                <button
                  class="btn btn-danger btn-small"
                  data-role-min="admin"
                  onclick="deleteUser('${user.id}')"
                >
                  Eliminar
                </button>
              </td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        container.innerHTML = html;

      } catch (e) {
        console.error("Error cargando users:", e);
        container.innerHTML =
          '<p style="margin-top:10px;color:#b00020;">Error cargando usuarios.</p>';
      }
    }

    // ==============================
    // CREAR USUARIO (✅ SOLO ADMIN)
    // ==============================
    async function handleCreateUser(event) {
      event.preventDefault();

      try {
        assertCanCreateUsers();
      } catch (e) {
        alert(e.message || "No tiene permisos para crear usuarios.");
        return;
      }

      const username = normUsername(document.getElementById("newUsername").value);
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;
      const email = (document.getElementById("newEmail").value || "").trim();

      if (!username || !password || !role) {
        alert("Complete usuario, contraseña y rol.");
        return;
      }

      // ID = usuario (NO se repite)
      // (si querés forzar lowercase para evitar duplicados por mayúsculas,
      // cambiá a: const usernameId = username.toLowerCase(); y usalo en todo)
      const usernameId = username;

      try {
        if (await userExists(usernameId)) {
          alert("Ya existe un usuario con ese nombre.");
          return;
        }

        const esMaestro = isMasterAdmin();
        const creador = currentUserName();

        const newUser = {
          username: usernameId,     // guardamos el mismo string
          password,                 // (en producción: hashear)
          role,
          email: email || null,
          active: esMaestro,
          status: esMaestro ? "active" : "pending",
          createdAt: new Date().toISOString(),
          createdBy: creador,
        };

        await createUserFirestore(newUser);

        logAudit({
          action: "CREATE_USER",
          resource: "users",
          success: true,
          details: `username=${usernameId}, role=${role}, createdBy=${creador}, status=${newUser.status}`,
        });

        alert(
          esMaestro
            ? "✅ Usuario creado y habilitado exitosamente."
            : "✅ Solicitud de usuario creada.\nUn administrador maestro debe habilitar esta cuenta."
        );

        event.target.reset();
        await loadUsers();

      } catch (err) {
        console.error("Error creando usuario:", err);
        alert(err.message || "Error al crear usuario.");
      }
    }

    // ==============================
    // EDITAR USUARIO (✅ ADMIN + PROFESIONAL)
    // ==============================
    async function editUserInternal(usernameId) {
      try {
        assertCanEditUsers();
      } catch (e) {
        alert(e.message || "No tiene permisos para editar usuarios.");
        return;
      }

      try {
        const ref = doc(db, USERS_COL, usernameId);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          alert("Usuario no encontrado.");
          return;
        }

        const u = { id: snap.id, ...snap.data() };

        const nuevoEmail = prompt("Email (vacío para N/A):", u.email || "");
        if (nuevoEmail === null) return;

        const nuevoRol = prompt(
          "Rol (admin / profesional / operador / lectura):",
          u.role || "lectura"
        );
        if (nuevoRol === null) return;

        const rolNorm = (nuevoRol || "").trim().toLowerCase();
        const rolesValidos = ["admin", "profesional", "operador", "lectura"];
        if (!rolesValidos.includes(rolNorm)) {
          alert("Rol inválido.");
          return;
        }

        const activoStr = prompt("¿Activo? (si/no):", u.active ? "si" : "no");
        if (activoStr === null) return;

        const activo = (activoStr || "").trim().toLowerCase();
        const nuevoActivo = activo === "si" || activo === "sí" || activo === "true";

        const updated = {
          email: (nuevoEmail || "").trim() ? (nuevoEmail || "").trim() : null,
          role: rolNorm,
          active: nuevoActivo,
          status: nuevoActivo ? "active" : "inactive",
          updatedAt: new Date().toISOString(),
          updatedBy: currentUserName(),
        };

        await updateUserFirestore(usernameId, updated);

        logAudit({
          action: "EDIT_USER",
          resource: "users",
          success: true,
          details: `username=${usernameId}, role=${u.role}->${rolNorm}, active=${u.active}->${nuevoActivo}`,
        });

        alert("✅ Usuario actualizado.");
        await loadUsers();

      } catch (err) {
        console.error("Error editando usuario:", err);
        alert("Error al editar usuario.");
      }
    }

    // ==============================
    // ELIMINAR USUARIO (✅ SOLO ADMIN)
    // ==============================
    async function deleteUserInternal(usernameId) {
      try {
        assertCanDeleteRecords("users");
      } catch (e) {
        alert(e.message || "No tiene permisos para eliminar usuarios.");
        return;
      }

      if (!confirm("¿Eliminar este usuario?")) return;

      try {
        await deleteUserFirestore(usernameId);

        logAudit({
          action: "DELETE_USER",
          resource: "users",
          success: true,
          details: `username=${usernameId}`,
        });

        alert("Usuario eliminado.");
        await loadUsers();

      } catch (err) {
        console.error("Error eliminando usuario:", err);
        alert("Error al eliminar usuario.");
      }
    }

    // ==============================
    // APROBAR USUARIO (SOLO MAESTRO)
    // ==============================
    async function approveUserInternal(usernameId) {
      if (!isMasterAdmin()) {
        alert("Solo el administrador maestro puede aprobar usuarios.");
        return;
      }

      try {
        await updateUserFirestore(usernameId, {
          active: true,
          status: "active",
          approvedAt: new Date().toISOString(),
          approvedBy: currentUserName(),
        });

        logAudit({
          action: "APPROVE_USER",
          resource: "users",
          success: true,
          details: `username=${usernameId}`,
        });

        alert("✅ Usuario aprobado y habilitado.");
        await loadUsers();

      } catch (err) {
        console.error("Error aprobando usuario:", err);
        alert("Error al aprobar usuario.");
      }
    }

    // ==============================
    // LOGOUT
    // ==============================
    function logoutInternal() {
      sessionStorage.clear();
      window.location.href = "../index.html";
    }

    // ==============================
    // INIT
    // ==============================
    document.addEventListener("DOMContentLoaded", async () => {
      initPagePermissions("user-management");

      const form = document.getElementById("userForm");
      if (form) form.addEventListener("submit", handleCreateUser);

      await loadUsers();
    });

    // Exponer funciones inline
    window.deleteUser = deleteUserInternal;
    window.approveUser = approveUserInternal;
    window.editUser = editUserInternal;
    window.logout = logoutInternal;
  </script>
</body>
</html>
